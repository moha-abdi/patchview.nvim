{
  "project": "patchview.nvim",
  "description": "Real-time diff visualization for Neovim when external tools edit files",
  "version": "0.1.0",
  "created": "2026-01-20",
  "tasks": [
    {
      "id": "T001",
      "category": "core",
      "priority": "P0",
      "title": "File watching with libuv",
      "description": "Implement file system watcher using vim.loop (libuv) to detect external file changes",
      "steps": [
        "Create watcher.lua module",
        "Implement fs_event based file watching",
        "Add debouncing to prevent rapid event flooding",
        "Handle file deletion and rename events"
      ],
      "acceptance_criteria": [
        "Watcher detects file changes within 200ms",
        "Debouncing prevents multiple events for single change",
        "Watcher can be started/stopped per buffer"
      ],
      "passes": true
    },
    {
      "id": "T002",
      "category": "core",
      "priority": "P0",
      "title": "Myers diff algorithm",
      "description": "Implement Myers diff algorithm to compute differences between old and new file content",
      "steps": [
        "Create diff.lua module",
        "Implement Myers algorithm for line-based diff",
        "Return structured change objects with type, lines, positions",
        "Handle edge cases (empty files, all added, all deleted)"
      ],
      "acceptance_criteria": [
        "Correctly identifies added lines",
        "Correctly identifies deleted lines",
        "Correctly identifies changed lines (delete + add)",
        "Returns proper line numbers for old and new content"
      ],
      "passes": true
    },
    {
      "id": "T003",
      "category": "core",
      "priority": "P0",
      "title": "Hunk management",
      "description": "Create hunk objects from diff changes for navigation and actions",
      "steps": [
        "Create hunks.lua module",
        "Convert diff changes to hunk objects",
        "Implement hunk navigation (next/prev)",
        "Track hunk status (pending/accepted/rejected)"
      ],
      "acceptance_criteria": [
        "Hunks created from diff changes with correct metadata",
        "Navigation jumps to correct hunk positions",
        "Hunk status can be changed and persisted"
      ],
      "passes": true
    },
    {
      "id": "T004",
      "category": "rendering",
      "priority": "P0",
      "title": "Inline highlighting with extmarks",
      "description": "Render diff visualization using Neovim extmarks for added/changed lines",
      "steps": [
        "Create render.lua module",
        "Use nvim_buf_set_extmark for line highlights",
        "Add sign column indicators",
        "Highlight line numbers for changed lines"
      ],
      "acceptance_criteria": [
        "Added lines show green background and sign",
        "Changed lines show appropriate highlighting",
        "Line numbers are highlighted to match change type"
      ],
      "passes": true
    },
    {
      "id": "T005",
      "category": "rendering",
      "priority": "P0",
      "title": "Virtual text for deleted lines",
      "description": "Show deleted lines as virtual text above the change location",
      "steps": [
        "Implement virt_lines rendering in render.lua",
        "Match gutter width (signs + line numbers)",
        "Show old line numbers for deleted content",
        "Handle deleted content styling (red background)"
      ],
      "acceptance_criteria": [
        "Deleted lines appear as virtual text above changes",
        "Virtual text aligns with buffer content",
        "Old line numbers displayed correctly"
      ],
      "passes": true
    },
    {
      "id": "T006",
      "category": "bugfix",
      "priority": "P0",
      "title": "Topfill workaround for row 0",
      "description": "Workaround for Neovim issue #16166 where virt_lines_above doesn't work on row 0",
      "steps": [
        "Detect when virtual lines are above row 0",
        "Use winrestview({ topfill = N }) to scroll viewport",
        "Set up autocmd to maintain topfill on cursor movement",
        "Clean up autocmds when clearing buffer"
      ],
      "acceptance_criteria": [
        "Virtual lines above line 1 are visible",
        "Topfill maintained when scrolling near top",
        "No memory leaks from autocmds"
      ],
      "passes": true
    },
    {
      "id": "T007",
      "category": "bugfix",
      "priority": "P0",
      "title": "Duplicate notification prevention",
      "description": "Prevent duplicate notifications when both watcher and FocusGained fire",
      "steps": [
        "Implement content-based deduplication using hash",
        "Track last processed content hash per buffer",
        "Skip processing if content hash matches"
      ],
      "acceptance_criteria": [
        "Only one notification per file change",
        "Both watcher and FocusGained can fire without duplicates",
        "Hash comparison is fast and reliable"
      ],
      "passes": true
    },
    {
      "id": "T008",
      "category": "bugfix",
      "priority": "P0",
      "title": "Off-screen changes visibility",
      "description": "Ensure changes to off-screen lines are properly rendered",
      "steps": [
        "Use silent! edit instead of checktime for reliable reload",
        "Save and restore cursor position during reload",
        "Add explicit redraw after setting extmarks",
        "Increase render delay for buffer load completion"
      ],
      "acceptance_criteria": [
        "Changes to off-screen lines visible when scrolling to them",
        "Cursor position preserved after external edit",
        "No need to refocus to see changes"
      ],
      "passes": true
    },
    {
      "id": "T009",
      "category": "core",
      "priority": "P1",
      "title": "Accept/Reject hunk actions",
      "description": "Allow users to accept or reject individual hunks",
      "steps": [
        "Implement accept_hunk action in actions.lua",
        "Implement reject_hunk action",
        "Update baseline after accept",
        "Revert content after reject",
        "Update hunk status and re-render"
      ],
      "acceptance_criteria": [
        "Accept hunk updates baseline and clears visualization",
        "Reject hunk reverts content to baseline",
        "Actions work on hunk at cursor position"
      ],
      "passes": true,
      "dependencies": ["T003"]
    },
    {
      "id": "T010",
      "category": "core",
      "priority": "P1",
      "title": "Accept/Reject all hunks",
      "description": "Batch accept or reject all pending hunks",
      "steps": [
        "Implement accept_all action",
        "Implement reject_all action",
        "Handle multiple hunks in correct order"
      ],
      "acceptance_criteria": [
        "Accept all updates baseline for all changes",
        "Reject all reverts all changes",
        "Proper notification of action result"
      ],
      "passes": true,
      "dependencies": ["T009"]
    },
    {
      "id": "T011",
      "category": "ux",
      "priority": "P1",
      "title": "Configurable keymaps",
      "description": "Allow users to configure keymaps for all actions",
      "steps": [
        "Define default keymaps in config.lua",
        "Allow disabling keymaps with false",
        "Set up keymaps during plugin setup"
      ],
      "acceptance_criteria": [
        "Default keymaps work out of the box",
        "Users can override keymaps in setup()",
        "Setting keymap to false disables it"
      ],
      "passes": true
    },
    {
      "id": "T012",
      "category": "integration",
      "priority": "P1",
      "title": "Telescope integration",
      "description": "Provide Telescope picker for viewing and navigating changes",
      "steps": [
        "Create telescope.lua module",
        "Implement picker for hunks in current buffer",
        "Implement picker for all files with changes",
        "Add preview and actions from picker"
      ],
      "acceptance_criteria": [
        "Telescope picker shows all hunks",
        "Selecting hunk jumps to location",
        "Can accept/reject from picker"
      ],
      "passes": true
    },

    {
      "id": "T014",
      "category": "ux",
      "priority": "P2",
      "title": "Preview mode",
      "description": "Show changes without auto-accepting, require manual accept/reject",
      "steps": [
        "Add mode option (auto/preview) to config",
        "In preview mode, don't update baseline automatically",
        "Keep visualization until user accepts/rejects"
      ],
      "acceptance_criteria": [
        "Preview mode shows persistent diff visualization",
        "Changes not applied until explicitly accepted",
        "Mode can be toggled at runtime"
      ],
      "passes": true
    },
    {
      "id": "T015",
      "category": "ux",
      "priority": "P2",
      "title": "Statusline component",
      "description": "Provide statusline component showing change summary",
      "steps": [
        "Implement statusline() function in status.lua",
        "Show count of pending hunks",
        "Show additions/deletions count"
      ],
      "acceptance_criteria": [
        "Statusline shows pending hunk count",
        "Updates when changes detected",
        "Returns empty string when no changes"
      ],
      "passes": true
    },
    {
      "id": "T016",
      "category": "ux",
      "priority": "P2",
      "title": "Animation/fade effects",
      "description": "Animate highlight changes for better visual feedback",
      "steps": [
        "Add animation config options",
        "Implement fade_out function in render.lua",
        "Gradually reduce highlight intensity"
      ],
      "acceptance_criteria": [
        "Highlights fade out after configured duration",
        "Animation can be disabled in config",
        "Smooth visual transition"
      ],
      "passes": true
    },
    {
      "id": "T017",
      "category": "docs",
      "priority": "P1",
      "title": "README documentation",
      "description": "Comprehensive README with installation, configuration, and usage",
      "steps": [
        "Add installation instructions (lazy.nvim, packer)",
        "Document all configuration options",
        "Add usage examples and keymaps",
        "Include screenshots/GIFs"
      ],
      "acceptance_criteria": [
        "Clear installation instructions",
        "All config options documented",
        "Examples for common use cases"
      ],
      "passes": true
    },
    {
      "id": "T018",
      "category": "docs",
      "priority": "P2",
      "title": "Vimdoc help file",
      "description": "Create :help patchview documentation",
      "steps": [
        "Create doc/patchview.txt",
        "Document all commands",
        "Document all functions",
        "Add examples and tips"
      ],
      "acceptance_criteria": [
        ":help patchview works",
        "All commands documented",
        "Proper vimdoc formatting"
      ],
      "passes": true
    },
    {
      "id": "T019",
      "category": "testing",
      "priority": "P2",
      "title": "Unit tests for diff algorithm",
      "description": "Test suite for the Myers diff implementation",
      "steps": [
        "Create tests/test_diff.lua",
        "Test added lines detection",
        "Test deleted lines detection",
        "Test changed lines detection",
        "Test edge cases"
      ],
      "acceptance_criteria": [
        "All diff scenarios covered",
        "Tests can run with plenary.nvim",
        "Clear test output"
      ],
      "passes": true
    },

    {
      "id": "T021",
      "category": "ux",
      "priority": "P2",
      "title": "Split diff view",
      "description": "Show side-by-side diff in split windows",
      "steps": [
        "Create preview.lua module",
        "Open split with original content",
        "Sync scrolling between windows",
        "Highlight changes in both windows"
      ],
      "acceptance_criteria": [
        "Split view shows old vs new content",
        "Scroll sync works correctly",
        "Can close split with keymap"
      ],
      "passes": true
    },
    {
      "id": "T022",
      "category": "core",
      "priority": "P1",
      "title": "Pure delete hunk handling",
      "description": "Correctly handle hunks that only delete lines without adding any",
      "steps": [
        "Skip inline highlighting for pure delete hunks",
        "Only show virtual text for deleted content",
        "Ensure sign is shown at correct position"
      ],
      "acceptance_criteria": [
        "Pure delete shows only virtual text",
        "No incorrect highlighting on adjacent lines",
        "Delete sign visible at deletion point"
      ],
      "passes": true
    },

    {
      "id": "T024",
      "category": "core",
      "priority": "P1",
      "title": "Ignore patterns",
      "description": "Allow users to ignore certain files from watching",
      "steps": [
        "Add ignore_patterns to config",
        "Check patterns before starting watcher",
        "Support glob patterns"
      ],
      "acceptance_criteria": [
        "Configured patterns are ignored",
        "Glob patterns work (*.tmp, node_modules/*)",
        "Patterns checked efficiently"
      ],
      "passes": true
    },
    {
      "id": "T025",
      "category": "bugfix",
      "priority": "P1",
      "title": "Trailing newline handling",
      "description": "Correctly handle files with/without trailing newlines",
      "steps": [
        "Normalize line reading to match nvim_buf_get_lines",
        "Remove trailing empty line from file reads",
        "Ensure diff doesn't show phantom changes"
      ],
      "acceptance_criteria": [
        "No false positives from trailing newline differences",
        "File content matches buffer content",
        "Works with various line ending styles"
      ],
      "passes": true
    },
    {
      "id": "T026",
      "category": "ux",
      "priority": "P1",
      "title": "Floating action bar widget",
      "description": "Show a floating widget near changes with navigation and quick actions (like Cursor IDE). Displays hunk position (X of Y), Undo/Reject button, Keep/Accept button with keyboard shortcuts.",
      "steps": [
        "Create floating window positioned near current hunk",
        "Show hunk counter (e.g., '3 of 9')",
        "Add Reject button showing configured keymap (e.g., <leader>pr)",
        "Add Accept button showing configured keymap (e.g., <leader>pa)",
        "Add navigation arrows to cycle through hunks",
        "Auto-position to avoid overlapping with content",
        "Update widget when cursor moves between hunks",
        "Hide widget when no changes or cursor outside hunks"
      ],
      "acceptance_criteria": [
        "Widget appears when changes are detected",
        "Shows correct hunk position (X of Y)",
        "Undo button rejects current hunk",
        "Keep button accepts current hunk",
        "Navigation cycles through hunks",
        "Widget repositions appropriately",
        "Keyboard shortcuts work from widget"
      ],
      "passes": false
    },
    {
      "id": "T027",
      "category": "ux",
      "priority": "P1",
      "title": "Follow changes (auto-scroll)",
      "description": "Automatically scroll/jump to where external changes happen in real-time. When an AI or external tool edits a line elsewhere in the file, the view follows to show the change. Configurable on/off.",
      "steps": [
        "Add follow_changes option to config (default: true)",
        "After detecting change, get the first hunk's line number",
        "Scroll viewport to center the change in view",
        "Preserve cursor column position if possible",
        "Add command to toggle follow mode at runtime",
        "Consider smooth scrolling animation option"
      ],
      "acceptance_criteria": [
        "When change detected off-screen, view scrolls to show it",
        "Change is centered in viewport (not at edge)",
        "Can be disabled via config",
        "Can be toggled at runtime with command",
        "Cursor position handled gracefully"
      ],
      "passes": false
    },
    {
      "id": "T028",
      "category": "ux",
      "priority": "P1",
      "title": "Undo last accept/reject",
      "description": "Safety net for accidental actions. Keep a short history of accept/reject operations and allow undoing them. Like Cmd+Z but specifically for patchview actions.",
      "steps": [
        "Create action history stack per buffer",
        "Store hunk content and action type before accept/reject",
        "Implement undo_last_action function",
        "Restore hunk content and status on undo",
        "Add keymap for undo (e.g., <leader>pu)",
        "Add :PatchviewUndo command",
        "Limit history size to prevent memory issues",
        "Clear history on buffer write or new baseline"
      ],
      "acceptance_criteria": [
        "Can undo last accept (restores deleted content)",
        "Can undo last reject (re-applies the change)",
        "History persists until buffer write",
        "Keymap and command work correctly",
        "Notification confirms undo action"
      ],
      "passes": false
    }
  ]
}
